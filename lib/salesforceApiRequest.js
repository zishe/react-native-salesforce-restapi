var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.SalesforceApiRequest=exports.STORAGE_EXPIRE_SPAN=exports.STORAGE_KEY=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _reactNative=require("react-native");var HTTP_UNAUTHORIZED=401;var STORAGE_KEY='@SalesforceApiRequest:Credentials';exports.STORAGE_KEY=STORAGE_KEY;var STORAGE_EXPIRE_SPAN=1000*60*60*24;exports.STORAGE_EXPIRE_SPAN=STORAGE_EXPIRE_SPAN;var OAUTH_REFRESH_TOKEN_GRANT_TYPE='refresh_token';var OAUTH_SALESFORCE_LOGIN_URL='https://login.salesforce.com/services/oauth2/token';var SalesforceApiRequest=function(){function SalesforceApiRequest(nativeMethods){(0,_classCallCheck2.default)(this,SalesforceApiRequest);this.nativeMethods=nativeMethods;}(0,_createClass2.default)(SalesforceApiRequest,[{key:"isLoggedIn",value:function isLoggedIn(){var credentials;return _regenerator.default.async(function isLoggedIn$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return _regenerator.default.awrap(this.getStoredCredentials());case 2:credentials=_context.sent;return _context.abrupt("return",credentials!=null);case 4:case"end":return _context.stop();}}},null,this);}},{key:"logOut",value:function logOut(){return _regenerator.default.async(function logOut$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return _regenerator.default.awrap(_reactNative.AsyncStorage.removeItem(STORAGE_KEY));case 2:_context2.next=4;return _regenerator.default.awrap(this.nativeMethods.logout());case 4:case"end":return _context2.stop();}}},null,this);}},{key:"getCredentials",value:function getCredentials(parameters){var credentials;return _regenerator.default.async(function getCredentials$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return _regenerator.default.awrap(this.getStoredCredentials());case 2:credentials=_context3.sent;if(!credentials){_context3.next=5;break;}return _context3.abrupt("return",credentials);case 5:_context3.next=7;return _regenerator.default.awrap(this.nativeMethods.loginUser(parameters));case 7:credentials=_context3.sent;_context3.next=10;return _regenerator.default.awrap(this.setCredentials(credentials));case 10:return _context3.abrupt("return",credentials);case 11:case"end":return _context3.stop();}}},null,this);}},{key:"getStoredCredentials",value:function getStoredCredentials(parameters){var credentials;return _regenerator.default.async(function getStoredCredentials$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.prev=0;_context4.t0=JSON;_context4.next=4;return _regenerator.default.awrap(_reactNative.AsyncStorage.getItem(STORAGE_KEY));case 4:_context4.t1=_context4.sent;credentials=_context4.t0.parse.call(_context4.t0,_context4.t1);if(!(Date.now()-credentials.issued_at>STORAGE_EXPIRE_SPAN)){_context4.next=8;break;}throw new Error('Storage key expired');case 8:return _context4.abrupt("return",credentials);case 11:_context4.prev=11;_context4.t2=_context4["catch"](0);_context4.next=15;return _regenerator.default.awrap(this.logOut());case 15:return _context4.abrupt("return",null);case 16:case"end":return _context4.stop();}}},null,this,[[0,11]]);}},{key:"setCredentials",value:function setCredentials(credentials){return _regenerator.default.async(function setCredentials$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return _regenerator.default.awrap(_reactNative.AsyncStorage.setItem(STORAGE_KEY,JSON.stringify(credentials)));case 2:case"end":return _context5.stop();}}});}},{key:"post",value:function post(parameters,url,body){var fetchAction;return _regenerator.default.async(function post$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:fetchAction=function fetchAction(cred){return fetch(cred.instance_url+"/services/apexrest/"+parameters.namespace+url,{method:'post',headers:{'Authorization':"Bearer "+cred.access_token,'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(body)});};_context6.next=3;return _regenerator.default.awrap(this.apiCall(fetchAction,parameters,url));case 3:return _context6.abrupt("return",_context6.sent);case 4:case"end":return _context6.stop();}}},null,this);}},{key:"apiCall",value:function apiCall(fetchAction,parameters,url){var credentials,processResponse,response,newCredentials;return _regenerator.default.async(function apiCall$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:_context8.next=2;return _regenerator.default.awrap(this.getCredentials(parameters));case 2:credentials=_context8.sent;processResponse=function processResponse(response){return _regenerator.default.async(function processResponse$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:if(!response.ok){_context7.next=7;break;}_context7.next=3;return _regenerator.default.awrap(response.json());case 3:_context7.t0=_context7.sent;_context7.t1=response.status;_context7.t2=response;return _context7.abrupt("return",{json:_context7.t0,status:_context7.t1,response:_context7.t2});case 7:throw response;case 8:case"end":return _context7.stop();}}});};_context8.next=6;return _regenerator.default.awrap(fetchAction(credentials));case 6:response=_context8.sent;if(!(response.status===HTTP_UNAUTHORIZED)){_context8.next=14;break;}_context8.next=10;return _regenerator.default.awrap(this.refreshToken(parameters,credentials));case 10:newCredentials=_context8.sent;_context8.next=13;return _regenerator.default.awrap(fetchAction(newCredentials).then(processResponse));case 13:return _context8.abrupt("return",_context8.sent);case 14:return _context8.abrupt("return",processResponse(response));case 15:case"end":return _context8.stop();}}},null,this);}},{key:"refreshToken",value:function refreshToken(parameters,credentials){var refreshParams,form,response,newCredentials;return _regenerator.default.async(function refreshToken$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:_context9.next=2;return _regenerator.default.awrap(this.logOut());case 2:refreshParams={grant_type:OAUTH_REFRESH_TOKEN_GRANT_TYPE,refresh_token:credentials.refresh_token,client_id:parameters.consumerKey,client_secret:parameters.consumerSecret};form=Object.keys(refreshParams).map(function(k){return k+"="+encodeURIComponent(refreshParams[k]);}).join('&');_context9.next=6;return _regenerator.default.awrap(fetch(OAUTH_SALESFORCE_LOGIN_URL,{credentials:'include',method:'post',headers:{'Authorization':"Bearer "+credentials.access_token,'Accept':'application/json','Content-Type':'application/x-www-form-urlencoded; charset=utf-8'},body:form}));case 6:response=_context9.sent;if(response.ok){_context9.next=9;break;}throw response;case 9:_context9.next=11;return _regenerator.default.awrap(response.json());case 11:newCredentials=_context9.sent;credentials.access_token=newCredentials.access_token;_context9.next=15;return _regenerator.default.awrap(this.setCredentials(credentials));case 15:return _context9.abrupt("return",credentials);case 16:case"end":return _context9.stop();}}},null,this);}}]);return SalesforceApiRequest;}();exports.SalesforceApiRequest=SalesforceApiRequest;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NhbGVzZm9yY2VBcGlSZXF1ZXN0LmpzIl0sIm5hbWVzIjpbIkhUVFBfVU5BVVRIT1JJWkVEIiwiU1RPUkFHRV9LRVkiLCJTVE9SQUdFX0VYUElSRV9TUEFOIiwiT0FVVEhfUkVGUkVTSF9UT0tFTl9HUkFOVF9UWVBFIiwiT0FVVEhfU0FMRVNGT1JDRV9MT0dJTl9VUkwiLCJTYWxlc2ZvcmNlQXBpUmVxdWVzdCIsIm5hdGl2ZU1ldGhvZHMiLCJnZXRTdG9yZWRDcmVkZW50aWFscyIsImNyZWRlbnRpYWxzIiwiQXN5bmNTdG9yYWdlIiwicmVtb3ZlSXRlbSIsImxvZ291dCIsInBhcmFtZXRlcnMiLCJsb2dpblVzZXIiLCJzZXRDcmVkZW50aWFscyIsIkpTT04iLCJnZXRJdGVtIiwicGFyc2UiLCJEYXRlIiwibm93IiwiaXNzdWVkX2F0IiwiRXJyb3IiLCJsb2dPdXQiLCJzZXRJdGVtIiwic3RyaW5naWZ5IiwidXJsIiwiYm9keSIsImZldGNoQWN0aW9uIiwiY3JlZCIsImZldGNoIiwiaW5zdGFuY2VfdXJsIiwibmFtZXNwYWNlIiwibWV0aG9kIiwiaGVhZGVycyIsImFjY2Vzc190b2tlbiIsImFwaUNhbGwiLCJnZXRDcmVkZW50aWFscyIsInByb2Nlc3NSZXNwb25zZSIsInJlc3BvbnNlIiwib2siLCJqc29uIiwic3RhdHVzIiwicmVmcmVzaFRva2VuIiwibmV3Q3JlZGVudGlhbHMiLCJ0aGVuIiwicmVmcmVzaFBhcmFtcyIsImdyYW50X3R5cGUiLCJyZWZyZXNoX3Rva2VuIiwiY2xpZW50X2lkIiwiY29uc3VtZXJLZXkiLCJjbGllbnRfc2VjcmV0IiwiY29uc3VtZXJTZWNyZXQiLCJmb3JtIiwiT2JqZWN0Iiwia2V5cyIsIm1hcCIsImsiLCJlbmNvZGVVUklDb21wb25lbnQiLCJqb2luIl0sIm1hcHBpbmdzIjoicWVBVUEseUNBVkEsR0FBTUEsQ0FBQUEsaUJBQWlCLENBQUcsR0FBMUIsQ0FFTyxHQUFNQyxDQUFBQSxXQUFXLENBQUcsbUNBQXBCLEMs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SlIsQyxDQU1oQkMsSSxDQUFPQyxNQUFNLENBQUNDLElBQVAsQ0FBWVQsYUFBWixFQUEyQlUsR0FBM0IsQ0FBK0IsU0FBQ0MsQ0FBRCxRQUFTQSxDQUFBQSxDQUFULEtBQWNDLGtCQUFrQixDQUFDWixhQUFhLENBQUNXLENBQUQsQ0FBZCxDQUFoQyxFQUEvQixFQUFxRkUsSUFBckYsQ0FBMEYsR0FBMUYsQyxvREFFVTdCLEtBQUssQ0FBQ3pCLDBCQUFELENBQTZCLENBQ3JESSxXQUFXLENBQUUsU0FEd0MsQ0FFckR3QixNQUFNLENBQUUsTUFGNkMsQ0FHckRDLE9BQU8sQ0FBRSxDQUNMLDBCQUEyQnpCLFdBQVcsQ0FBQzBCLFlBRGxDLENBRUwsU0FBVSxrQkFGTCxDQUdMLGVBQWdCLGtEQUhYLENBSDRDLENBUXJEUixJQUFJLENBQUUwQixJQVIrQyxDQUE3QixDLFNBQXRCZCxRLG1CQVdEQSxRQUFRLENBQUNDLEUsK0JBQ0pELENBQUFBLFEsNERBR21CQSxRQUFRLENBQUNFLElBQVQsRSxVQUF2QkcsYyxnQkFFTm5DLFdBQVcsQ0FBQzBCLFlBQVosQ0FBMkJTLGNBQWMsQ0FBQ1QsWUFBMUMsQyxvREFFTSxLQUFLcEIsY0FBTCxDQUFvQk4sV0FBcEIsQywyQ0FFQ0EsVyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IEhUVFBfVU5BVVRIT1JJWkVEID0gNDAxXG5cbmV4cG9ydCBjb25zdCBTVE9SQUdFX0tFWSA9ICdAU2FsZXNmb3JjZUFwaVJlcXVlc3Q6Q3JlZGVudGlhbHMnXG5cbmV4cG9ydCBjb25zdCBTVE9SQUdFX0VYUElSRV9TUEFOID0gMTAwMCAqIDYwICogNjAgKiAyNFxuXG5jb25zdCBPQVVUSF9SRUZSRVNIX1RPS0VOX0dSQU5UX1RZUEUgPSAncmVmcmVzaF90b2tlbidcbmNvbnN0IE9BVVRIX1NBTEVTRk9SQ0VfTE9HSU5fVVJMID0gJ2h0dHBzOi8vbG9naW4uc2FsZXNmb3JjZS5jb20vc2VydmljZXMvb2F1dGgyL3Rva2VuJ1xuXG5cbmltcG9ydCB7IEFzeW5jU3RvcmFnZSB9IGZyb20gJ3JlYWN0LW5hdGl2ZSdcbiBcbmV4cG9ydCBjbGFzcyBTYWxlc2ZvcmNlQXBpUmVxdWVzdCB7XG5cblx0Y29uc3RydWN0b3IobmF0aXZlTWV0aG9kcykge1xuXHRcdHRoaXMubmF0aXZlTWV0aG9kcyA9IG5hdGl2ZU1ldGhvZHM7XG5cdH1cblxuICAgIGFzeW5jIGlzTG9nZ2VkSW4oKSB7XG4gICAgICAgIGxldCBjcmVkZW50aWFscyA9IGF3YWl0IHRoaXMuZ2V0U3RvcmVkQ3JlZGVudGlhbHMoKTtcbiAgICAgICAgcmV0dXJuIGNyZWRlbnRpYWxzICE9IG51bGw7XG4gICAgfVxuXG4gICAgYXN5bmMgbG9nT3V0KCkge1xuICAgICAgICBhd2FpdCBBc3luY1N0b3JhZ2UucmVtb3ZlSXRlbShTVE9SQUdFX0tFWSlcbiAgICAgICAgYXdhaXQgdGhpcy5uYXRpdmVNZXRob2RzLmxvZ291dCgpXG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0Q3JlZGVudGlhbHMocGFyYW1ldGVycykge1xuICAgICAgICBsZXQgY3JlZGVudGlhbHMgPSBhd2FpdCB0aGlzLmdldFN0b3JlZENyZWRlbnRpYWxzKCk7XG4gICAgICAgIFxuICAgICAgICBpZiAoY3JlZGVudGlhbHMpIHtcbiAgICAgICAgICAgIHJldHVybiBjcmVkZW50aWFscztcbiAgICAgICAgfVxuXG4gICAgICAgIGNyZWRlbnRpYWxzID0gYXdhaXQgdGhpcy5uYXRpdmVNZXRob2RzLmxvZ2luVXNlcihwYXJhbWV0ZXJzKTtcbiAgICAgICAgYXdhaXQgdGhpcy5zZXRDcmVkZW50aWFscyhjcmVkZW50aWFscyk7XG4gICAgICAgIHJldHVybiBjcmVkZW50aWFscztcbiAgICB9XG5cbiAgICBhc3luYyBnZXRTdG9yZWRDcmVkZW50aWFscyhwYXJhbWV0ZXJzKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBjcmVkZW50aWFscyA9IEpTT04ucGFyc2UoYXdhaXQgQXN5bmNTdG9yYWdlLmdldEl0ZW0oU1RPUkFHRV9LRVkpKTtcblxuICAgICAgICAgICAgaWYgKERhdGUubm93KCkgLSBjcmVkZW50aWFscy5pc3N1ZWRfYXQgPiBTVE9SQUdFX0VYUElSRV9TUEFOKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTdG9yYWdlIGtleSBleHBpcmVkJylcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGNyZWRlbnRpYWxzO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoKGVycm9yKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmxvZ091dCgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBcbiAgICBhc3luYyBzZXRDcmVkZW50aWFscyhjcmVkZW50aWFscykge1xuICAgICAgICBhd2FpdCBBc3luY1N0b3JhZ2Uuc2V0SXRlbShTVE9SQUdFX0tFWSwgSlNPTi5zdHJpbmdpZnkoY3JlZGVudGlhbHMpKVxuICAgIH1cblxuXHRhc3luYyBwb3N0KHBhcmFtZXRlcnMsIHVybCwgYm9keSkge1xuICAgICAgICBjb25zdCBmZXRjaEFjdGlvbiA9IChjcmVkKSA9PiBmZXRjaChgJHtjcmVkLmluc3RhbmNlX3VybH0vc2VydmljZXMvYXBleHJlc3QvJHtwYXJhbWV0ZXJzLm5hbWVzcGFjZX0ke3VybH1gLCB7XG4gICAgICAgICAgICBtZXRob2Q6ICdwb3N0JywgXG4gICAgICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHtjcmVkLmFjY2Vzc190b2tlbn1gLCBcbiAgICAgICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgICAgICAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgICAgICAgICAgIH0sIFxuICAgICAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KGJvZHkpXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5hcGlDYWxsKGZldGNoQWN0aW9uLCBwYXJhbWV0ZXJzLCB1cmwpXG4gICAgfVxuXG4gICAgYXN5bmMgYXBpQ2FsbChmZXRjaEFjdGlvbiwgcGFyYW1ldGVycywgdXJsKSB7XG5cdFx0Y29uc3QgY3JlZGVudGlhbHMgPSBhd2FpdCB0aGlzLmdldENyZWRlbnRpYWxzKHBhcmFtZXRlcnMpO1xuXG4gICAgICAgIGNvbnN0IHByb2Nlc3NSZXNwb25zZSA9IGFzeW5jIChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLm9rKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAganNvbjogYXdhaXQgcmVzcG9uc2UuanNvbigpLFxuICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IHJlc3BvbnNlLnN0YXR1cyxcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2U6IHJlc3BvbnNlXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRocm93IHJlc3BvbnNlO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaEFjdGlvbihjcmVkZW50aWFscyk7XG5cbiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gSFRUUF9VTkFVVEhPUklaRUQpIHtcbiAgICAgICAgICAgIGNvbnN0IG5ld0NyZWRlbnRpYWxzID0gYXdhaXQgdGhpcy5yZWZyZXNoVG9rZW4ocGFyYW1ldGVycywgY3JlZGVudGlhbHMpXG5cbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBmZXRjaEFjdGlvbihuZXdDcmVkZW50aWFscykudGhlbihwcm9jZXNzUmVzcG9uc2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHByb2Nlc3NSZXNwb25zZShyZXNwb25zZSlcblx0fVxuXG4gICAgYXN5bmMgcmVmcmVzaFRva2VuKHBhcmFtZXRlcnMsIGNyZWRlbnRpYWxzKSB7XG4gICAgICAgIC8vIFJlbW92ZSBleHBpcmVkIGNyZWRlbnRpYWxzLiBJbiBjYXNlIG9mIHN1Y2Nlc3MgcmVmcmVzaCBuZXcgY3JlZGVudGlhbHMgd2lsbCBiZSBzdG9yZWRcbiAgICAgICAgLy8gSW4gY2FzZSBvZiBlcnJvciBuZXh0IGNhbGwgdG8gdGhlIEFQSSB3aWxsIGZvcmNlIGxvZ2luIHNjcmVlbiB0byBhcHBlYXJcbiAgICAgICAgYXdhaXQgdGhpcy5sb2dPdXQoKTtcblxuICAgICAgICBjb25zdCByZWZyZXNoUGFyYW1zID0ge1xuICAgICAgICAgICAgZ3JhbnRfdHlwZTogT0FVVEhfUkVGUkVTSF9UT0tFTl9HUkFOVF9UWVBFLFxuICAgICAgICAgICAgcmVmcmVzaF90b2tlbjogY3JlZGVudGlhbHMucmVmcmVzaF90b2tlbixcbiAgICAgICAgICAgIGNsaWVudF9pZDogcGFyYW1ldGVycy5jb25zdW1lcktleSxcbiAgICAgICAgICAgIGNsaWVudF9zZWNyZXQ6IHBhcmFtZXRlcnMuY29uc3VtZXJTZWNyZXRcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBmb3JtID0gT2JqZWN0LmtleXMocmVmcmVzaFBhcmFtcykubWFwKChrKT0+IGAke2t9PSR7ZW5jb2RlVVJJQ29tcG9uZW50KHJlZnJlc2hQYXJhbXNba10pfWApLmpvaW4oJyYnKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goT0FVVEhfU0FMRVNGT1JDRV9MT0dJTl9VUkwsIHtcbiAgICAgICAgICAgIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScsXG4gICAgICAgICAgICBtZXRob2Q6ICdwb3N0JyxcbiAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHtjcmVkZW50aWFscy5hY2Nlc3NfdG9rZW59YCwgXG4gICAgICAgICAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZDsgY2hhcnNldD11dGYtOCdcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBib2R5OiBmb3JtXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgICAgIHRocm93IHJlc3BvbnNlXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBuZXdDcmVkZW50aWFscyA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKVxuXG4gICAgICAgIGNyZWRlbnRpYWxzLmFjY2Vzc190b2tlbiA9IG5ld0NyZWRlbnRpYWxzLmFjY2Vzc190b2tlbjtcblxuICAgICAgICBhd2FpdCB0aGlzLnNldENyZWRlbnRpYWxzKGNyZWRlbnRpYWxzKTtcblxuICAgICAgICByZXR1cm4gY3JlZGVudGlhbHM7XG4gICAgfVxufSJdfQ==